{% extends "base.html" %}

{% block title %}ุงุฎุชุจุงุฑ ุงูุจุญุซ - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">๐ ุงุฎุชุจุงุฑ ุงูุจุญุซ</h1>
            <p class="text-muted">ุงุฎุชุจุงุฑ ุงูุจุญุซ ุงูููุฑุฏ ูุงููุฌูุน ูุฃุฑูุงู ุงูููุงุชู</p>
        </div>
        <div>
            <button class="btn btn-outline-primary" onclick="loadTestNumbers()">
                <i class="fas fa-database me-2"></i>ุชุญููู ุฃุฑูุงู ุชุฌุฑูุจูุฉ
            </button>
        </div>
    </div>

    <div class="row">
        <!-- ุงูุจุญุซ ุงูููุฑุฏ -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-search me-2"></i>ุงูุจุญุซ ุงูููุฑุฏ
                    </h5>
                </div>
                <div class="card-body">
                    <form id="singleSearchForm">
                        <div class="mb-3">
                            <label for="singlePhone" class="form-label">ุฑูู ุงููุงุชู</label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="singlePhone" 
                                   placeholder="+9647809394930"
                                   value="+9647809394930">
                            <div class="form-text">ุฃุฏุฎู ุงูุฑูู ุจุงูุตูุบุฉ ุงูุฏูููุฉ</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="singleSearchBtn">
                            <i class="fas fa-search me-2"></i>ุจุญุซ
                        </button>
                    </form>
                    
                    <!-- ูุชูุฌุฉ ุงูุจุญุซ ุงูููุฑุฏ -->
                    <div id="singleResult" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- ุงูุจุญุซ ุงููุฌูุน -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>ุงูุจุญุซ ุงููุฌูุน
                    </h5>
                </div>
                <div class="card-body">
                    <form id="bulkSearchForm">
                        <div class="mb-3">
                            <label for="bulkPhones" class="form-label">ุฃุฑูุงู ุงูููุงุชู</label>
                            <textarea class="form-control" 
                                      id="bulkPhones" 
                                      rows="6" 
                                      placeholder="ุฃุฏุฎู ุงูุฃุฑูุงู (ุฑูู ูุงุญุฏ ูู ูู ุณุทุฑ)">+9647809394930
+9647801234567
+9647901234567
+9647812345678
+9647823456789</textarea>
                            <div class="form-text">ุฑูู ูุงุญุฏ ูู ูู ุณุทุฑ - ุญุชู 100 ุฑูู</div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="maxConcurrent" class="form-label">ุงูุทูุจุงุช ุงููุชุฒุงููุฉ</label>
                                <select class="form-select" id="maxConcurrent">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3" selected>3</option>
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="delayBetween" class="form-label">ุงูุชุฃุฎูุฑ (ุซุงููุฉ)</label>
                                <select class="form-select" id="delayBetween">
                                    <option value="0.5">0.5</option>
                                    <option value="1.0" selected>1.0</option>
                                    <option value="2.0">2.0</option>
                                    <option value="3.0">3.0</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success btn-lg w-100" id="bulkSearchBtn">
                            <i class="fas fa-list me-2"></i>ุจุญุซ ูุฌูุน
                        </button>
                    </form>
                    
                    <!-- ุชูุฏู ุงูุจุญุซ ุงููุฌูุน -->
                    <div id="bulkProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="bulkProgressBar" 
                                 style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <span id="bulkProgressText">ุฌุงุฑู ุงูุจุญุซ...</span>
                        </div>
                    </div>
                    
                    <!-- ูุชุงุฆุฌ ุงูุจุญุซ ุงููุฌูุน -->
                    <div id="bulkResults" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>ุฅุญุตุงุฆูุงุช ุงูุฌูุณุฉ ุงูุญุงููุฉ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h4 class="text-primary mb-1" id="stat-total">0</h4>
                                <small class="text-muted">ุฅุฌูุงูู ุงูุทูุจุงุช</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h4 class="text-success mb-1" id="stat-success">0</h4>
                                <small class="text-muted">ูุฌุญ</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h4 class="text-danger mb-1" id="stat-failed">0</h4>
                                <small class="text-muted">ูุดู</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <h4 class="text-info mb-1" id="stat-rate">0%</h4>
                                <small class="text-muted">ูุนุฏู ุงููุฌุงุญ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ุณุฌู ุงูุนูููุงุช -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>ุณุฌู ุงูุนูููุงุช
                    </h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearLog()">
                        <i class="fas fa-trash me-1"></i>ูุณุญ ุงูุณุฌู
                    </button>
                </div>
                <div class="card-body">
                    <div id="operationLog" class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                        <p class="text-muted mb-0">ุณูุธูุฑ ููุง ุณุฌู ุฌููุน ุงูุนูููุงุช...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ูุชุบูุฑุงุช ุฅุญุตุงุฆูุงุช ุงูุฌูุณุฉ
let sessionStats = {
    total: 0,
    success: 0,
    failed: 0
};

// ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
function updateStats() {
    document.getElementById('stat-total').textContent = sessionStats.total;
    document.getElementById('stat-success').textContent = sessionStats.success;
    document.getElementById('stat-failed').textContent = sessionStats.failed;
    
    const rate = sessionStats.total > 0 ? 
        Math.round((sessionStats.success / sessionStats.total) * 100) : 0;
    document.getElementById('stat-rate').textContent = rate + '%';
}

// ุฅุถุงูุฉ ุฑุณุงูุฉ ููุณุฌู
function addToLog(message, type = 'info') {
    const log = document.getElementById('operationLog');
    const timestamp = new Date().toLocaleTimeString('ar-IQ');
    const icon = {
        'info': 'fas fa-info-circle text-info',
        'success': 'fas fa-check-circle text-success',
        'error': 'fas fa-exclamation-circle text-danger',
        'warning': 'fas fa-exclamation-triangle text-warning'
    }[type] || 'fas fa-info-circle text-info';
    
    const logEntry = document.createElement('div');
    logEntry.className = 'mb-2 p-2 border-bottom';
    logEntry.innerHTML = `
        <span class="text-muted small">[${timestamp}]</span>
        <i class="${icon} me-2"></i>
        ${message}
    `;
    
    // ุฅุฏุฑุงุฌ ูู ุงูุฃุนูู
    if (log.firstChild.tagName) {
        log.insertBefore(logEntry, log.firstChild);
    } else {
        log.innerHTML = '';
        log.appendChild(logEntry);
    }
    
    // ุงูุญุฏ ุงูุฃูุตู 50 ุฑุณุงูุฉ
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

// ูุณุญ ุงูุณุฌู
function clearLog() {
    document.getElementById('operationLog').innerHTML = 
        '<p class="text-muted mb-0">ุชู ูุณุญ ุงูุณุฌู...</p>';
}

// ุชุญููู ุฃุฑูุงู ุชุฌุฑูุจูุฉ
function loadTestNumbers() {
    const testNumbers = [
        '+9647809394930',
        '+9647801234567',
        '+9647901234567',
        '+9647812345678',
        '+9647823456789',
        '+9647834567890',
        '+9647845678901',
        '+9647856789012'
    ];
    
    document.getElementById('bulkPhones').value = testNumbers.join('\n');
    addToLog('ุชู ุชุญููู ุงูุฃุฑูุงู ุงูุชุฌุฑูุจูุฉ', 'info');
}

// ุงูุจุญุซ ุงูููุฑุฏ
document.getElementById('singleSearchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const phoneNumber = document.getElementById('singlePhone').value.trim();
    const btn = document.getElementById('singleSearchBtn');
    const resultDiv = document.getElementById('singleResult');
    
    if (!phoneNumber) {
        TRUD.notifications.warning('ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููุงุชู');
        return;
    }
    
    // ุชุนุทูู ุงูุฒุฑ
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ุฌุงุฑู ุงูุจุญุซ...';
    
    addToLog(`ุจุฏุก ุงูุจุญุซ ุงูููุฑุฏ ุนู: ${phoneNumber}`, 'info');
    sessionStats.total++;
    updateStats();
    
    try {
        const response = await TRUD.api.post('/search/phone', {
            phone_number: phoneNumber
        });
        
        if (response.success) {
            sessionStats.success++;
            addToLog(`ูุฌุญ ุงูุจุญุซ ุนู ${phoneNumber} - ุงูุนุซูุฑ ุนูู: ${response.data.names?.[0] || 'ุบูุฑ ูุนุฑูู'}`, 'success');
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>ุชู ุงูุนุซูุฑ ุนูู ุงููุชุงุฆุฌ</h6>
                    <div class="row mt-3">
                        <div class="col-sm-6">
                            <strong>ุงูุฑูู:</strong> ${response.data.international || phoneNumber}<br>
                            <strong>ุงูุงุณู:</strong> ${response.data.names?.[0] || 'ุบูุฑ ูุชููุฑ'}<br>
                            <strong>ุงููุดุบู:</strong> ${response.data.carrier || 'ุบูุฑ ูุชููุฑ'}
                        </div>
                        <div class="col-sm-6">
                            <strong>ุงูุจูุฏ:</strong> ${response.data.country || 'ุบูุฑ ูุชููุฑ'}<br>
                            <strong>ุงูููุน:</strong> <span class="badge ${response.data.is_spam ? 'bg-warning' : 'bg-success'}">${response.data.is_spam ? 'ูุฒุนุฌ' : 'ุนุงุฏู'}</span><br>
                            <strong>ููุช ุงูุงุณุชุฌุงุจุฉ:</strong> ${TRUD.Utils.formatDuration(response.response_time)}
                        </div>
                    </div>
                </div>
            `;
        } else {
            sessionStats.failed++;
            addToLog(`ูุดู ุงูุจุญุซ ุนู ${phoneNumber}: ${response.error}`, 'error');
            
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>ูู ูุชู ุงูุนุซูุฑ ุนูู ูุชุงุฆุฌ</h6>
                    <p class="mb-0">${response.error || 'ุงูุฑูู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช'}</p>
                </div>
            `;
        }
        
    } catch (error) {
        sessionStats.failed++;
        addToLog(`ุฎุทุฃ ูู ุงูุจุญุซ ุนู ${phoneNumber}: ${error.message}`, 'error');
        
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-times-circle me-2"></i>ุญุฏุซ ุฎุทุฃ</h6>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-search me-2"></i>ุจุญุซ';
        updateStats();
    }
});

// ุงูุจุญุซ ุงููุฌูุน
document.getElementById('bulkSearchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const phonesText = document.getElementById('bulkPhones').value.trim();
    const maxConcurrent = parseInt(document.getElementById('maxConcurrent').value);
    const delayBetween = parseFloat(document.getElementById('delayBetween').value);
    
    const phoneNumbers = phonesText.split('\n')
        .map(line => line.trim())
        .filter(line => line !== '');
    
    if (phoneNumbers.length === 0) {
        TRUD.notifications.warning('ูุฑุฌู ุฅุฏุฎุงู ุฃุฑูุงู ุงูููุงุชู');
        return;
    }
    
    if (phoneNumbers.length > 100) {
        TRUD.notifications.warning('ูููู ุงูุจุญุซ ุนู 100 ุฑูู ูุญุฏ ุฃูุตู');
        return;
    }
    
    const btn = document.getElementById('bulkSearchBtn');
    const progressDiv = document.getElementById('bulkProgress');
    const progressBar = document.getElementById('bulkProgressBar');
    const progressText = document.getElementById('bulkProgressText');
    const resultsDiv = document.getElementById('bulkResults');
    
    // ุชุนุทูู ุงูุฒุฑ ูุฅุธูุงุฑ ุงูุชูุฏู
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ุฌุงุฑู ุงูุจุญุซ...';
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = 'ุฌุงุฑู ุงูุจุญุซ...';
    
    addToLog(`ุจุฏุก ุงูุจุญุซ ุงููุฌูุน ุนู ${phoneNumbers.length} ุฑูู`, 'info');
    sessionStats.total += phoneNumbers.length;
    updateStats();
    
    try {
        const response = await TRUD.api.post('/search/bulk', {
            phone_numbers: phoneNumbers,
            max_concurrent: maxConcurrent,
            delay_between_requests: delayBetween
        });
        
        sessionStats.success += response.successful_results;
        sessionStats.failed += response.failed_searches;
        
        addToLog(`ุงูุชูู ุงูุจุญุซ ุงููุฌูุน - ูุฌุญ: ${response.successful_results}, ูุดู: ${response.failed_searches}`, 'success');
        
        // ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฏู
        progressDiv.style.display = 'none';
        
        // ุนุฑุถ ุงููุชุงุฆุฌ
        let resultsHtml = `
            <div class="alert alert-info">
                <h6>ูุชุงุฆุฌ ุงูุจุญุซ ุงููุฌูุน</h6>
                <div class="row mt-3">
                    <div class="col-3">
                        <strong>ุฅุฌูุงูู:</strong> ${response.total_searched}
                    </div>
                    <div class="col-3">
                        <strong>ูุฌุญ:</strong> <span class="text-success">${response.successful_results}</span>
                    </div>
                    <div class="col-3">
                        <strong>ูุดู:</strong> <span class="text-danger">${response.failed_searches}</span>
                    </div>
                    <div class="col-3">
                        <strong>ุงููุนุฏู:</strong> ${Math.round((response.successful_results / response.total_searched) * 100)}%
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>ุงูุฑูู</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th>ุงูุงุณู</th>
                            <th>ุงููุดุบู</th>
                            <th>ุงูููุช</th>
                            <th>ุงูููุน</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        response.results.forEach(result => {
            const statusBadge = result.success ? 
                '<span class="badge bg-success">ูุฌุญ</span>' : 
                '<span class="badge bg-danger">ูุดู</span>';
            
            const spamBadge = result.data && result.data.is_spam ? 
                '<span class="badge bg-warning">ูุฒุนุฌ</span>' : 
                '<span class="badge bg-secondary">ุนุงุฏู</span>';
            
            resultsHtml += `
                <tr>
                    <td><code>${result.phone_number}</code></td>
                    <td>${statusBadge}</td>
                    <td>${result.data?.names?.[0] || '-'}</td>
                    <td>${result.data?.carrier || '-'}</td>
                    <td>${TRUD.Utils.formatDuration(result.response_time || 0)}</td>
                    <td>${result.success ? spamBadge : '-'}</td>
                </tr>
            `;
        });
        
        resultsHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        resultsDiv.innerHTML = resultsHtml;
        
    } catch (error) {
        sessionStats.failed += phoneNumbers.length;
        addToLog(`ุฎุทุฃ ูู ุงูุจุญุซ ุงููุฌูุน: ${error.message}`, 'error');
        
        progressDiv.style.display = 'none';
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-times-circle me-2"></i>ุญุฏุซ ุฎุทุฃ ูู ุงูุจุญุซ ุงููุฌูุน</h6>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-list me-2"></i>ุจุญุซ ูุฌูุน';
        updateStats();
    }
});

// ุชุญุฏูุซ ุงูุตูุญุฉ ูู 30 ุซุงููุฉ ููุฑุงูุจุฉ ุงูุญุงูุฉ
setInterval(function() {
    if (sessionStats.total > 0) {
        addToLog('ุชุญุฏูุซ ุชููุงุฆู ููุฅุญุตุงุฆูุงุช', 'info');
    }
}, 30000);
</script>
{% endblock %}